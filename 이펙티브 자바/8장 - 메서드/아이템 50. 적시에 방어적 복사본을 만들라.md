# 아이템 50. 적시에 방어적 복사본을 만들라

클라이언트가 우리의 불변식을 깨트리려 혈안이 되어 있다고 가정하고 방어적으로 프로그래밍해야 한다.

`Date`는 낡은 API이니 새 코드를 작성할 때엔 더는 사용하면 안되지만, 다른 API들에 그 잔재가 남아있다.

외부 공격으로부터 인스턴스의 내부를 보호하려면 생성자에서 받은 가변 매개변수 각각을 방어적으로 복사해야 한다.

```java
Date start = new Date();
Date end = new Date();

Period p = new Period(start, end);
end.setYear(78); // p의 내부를 수정한다.
```

매개변수의 유효성을 검사하기 전에 방어적 복사본을 만들고 그 복사본으로 유효성을 검사하자. 멀티 스레딩 환경이라면 원본 객체의 유효성을 검사한 후 복사본을 만드는 그 찰나의 취약한 순간에 다른 스레드가 원본 객체를 수정할 위험이 있기 때문이다.

매개변수가 제3자에게 확장될 수 있는 타입이라면 방어적 복사본을 만들 때도 그 제3자의 구현을 신뢰할 수 없다. 그래서 `clone`을 사용해서는 안된다.

## 정리

클래스가 클라이언트로부터 받는 혹은 클라이언트로 반환하는 구성요소가 가변이라면 그 요소는 반드시 방어적으로 복사해야 한다.

복사 비용이 너무 크거나 클라이언트가 그 요소를 잘못 수정할 일이 없음을 신뢰한다면 방어적 복사를 수행하는 대신 해당 구성 요소를 수정했을 때의 책임이 클라이언트에 있음을 문서에 명시하도록 하자
